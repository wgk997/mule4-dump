<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:avio-core="http://www.mulesoft.org/schema/mule/avio-core" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/avio-core http://www.mulesoft.org/schema/mule/avio-core/current/mule-avio-core.xsd">
	<flow name="post:\notifications\(caseId):application\json:aepi-medical-alert-pro-api-config">
        <avio-core:custom-logger doc:name="Log Start" doc:id="6ba07422-12cc-403e-9e92-9a4d77aa7987" config-ref="avio-core-config" correlation_id="#[vars.headerAttributes.correlationId]" message="Start Processing Request for Post Notifications" tracePoint="START"/>
		<ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" doc:name="caseId">
            <ee:variables>
                <ee:set-variable variableName="caseId">attributes.uriParams.'caseId'</ee:set-variable>
            </ee:variables>
        </ee:transform>
		<ee:transform doc:name="smsMessage" doc:id="ddc2a436-1296-44ba-b513-ad2bcc475c02" >
			<ee:variables >
				<ee:set-variable variableName="smsMessage" ><![CDATA[payload.smsMessage]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		
        <flow-ref doc:name="custom-choice-subflow" doc:id="176bd5e5-92a2-4377-a9ba-456e93256d9a" name="custom-choice-flow" />
		<ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:name="final Response">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  statusCode: 201,
  message: "Added",
  smsMessage: vars.smsMessage,
  notifications: 
    vars.smsResult map {
    	"to": $.cellNumbers,
    	"status" : "SENT"
    }
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
		<avio-core:custom-logger doc:name="Log End" doc:id="99746ab6-946c-4ba5-b02e-fae74a84ee69" config-ref="avio-core-config" correlation_id="#[vars.headerAttributes.correlationId]" message="Completed Processing Request for Post Notifications" tracePoint="END"/>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="d9dfb2f1-a42d-4284-8b72-f5cc122712d1" >
				<avio-core:custom-logger doc:name="Log Error" doc:id="7074bebf-0a75-4188-80dd-7d7534c22c77" config-ref="avio-core-config" correlation_id="#[vars.headerAttributes.correlationId]" message="ERROR -While sending the otification " payload='#[write(payload, "application/json")]' category="${logcat}" logLocationInfo="true" level="ERROR"/>
			</on-error-propagate>
		</error-handler>
    </flow>
    	<sub-flow name="custom-choice-flow" doc:id="81e8dc7b-9782-4936-bf66-6e1c12cfc800" >
		<choice doc:name="Is Notification Custom" doc:id="861ae064-fd47-4d97-8893-fbf018c9f9a8">
			<when expression='#[payload.notificationType != "CUSTOM_NOTIFICATIONS"]'>
				<avio-core:custom-logger doc:name="Log no" doc:id="a2d189e5-89f1-4d4e-8a92-0c70aafd559e" config-ref="avio-core-config" correlation_id="#[vars.headerAttributes.correlationId]" category="${logcat}" />
				<flow-ref doc:name="not-custom-message-flow" doc:id="fff84413-0c07-4dd2-add8-f9501ff62404" name="not-custom-flow" />
			</when>
			<when expression='#[payload.notificationType == "CUSTOM_NOTIFICATIONS"]'>
				<avio-core:custom-logger doc:name="Log yes" doc:id="0d8bb342-75e3-411e-bd6b-b6467441518d" config-ref="avio-core-config" category="${logcat}" correlation_id="#[vars.headerAttributes.correlationId]" />
				<flow-ref doc:name="custom-flow" doc:id="b5656652-64ff-4b51-b77b-32342c769905" name="custom-flow" />
			</when>
			<otherwise>
				<avio-core:custom-logger doc:name="Log default" doc:id="b4d00dba-1e4f-4c36-bcf8-abb5c60fd01d" config-ref="avio-core-config" correlation_id="#[vars.headerAttributes.correlationId]" message="notificationType either null or doesn't exist !   " category="${logcat}" />
			</otherwise>
		</choice>
	</sub-flow>

</mule>
