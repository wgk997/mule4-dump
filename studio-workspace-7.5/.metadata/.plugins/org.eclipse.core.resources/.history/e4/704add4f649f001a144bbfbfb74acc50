<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:avio-core="http://www.mulesoft.org/schema/mule/avio-core" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/avio-core http://www.mulesoft.org/schema/mule/avio-core/current/mule-avio-core.xsd">

	<flow name="get-case" doc:id="02b2ef92-552a-43db-9236-a3801068415d" >
		<avio-core:custom-logger doc:name="Log Start" doc:id="da079ea0-dea4-4fe0-bbc1-9cc8c85ffd05" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" tracePoint="START" category="${logcat}" message="Start Processing Request for get-case"/>
		<ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" doc:name="VARS: caseId">
            <ee:variables>
                <ee:set-variable variableName="caseId"><![CDATA[attributes.uriParams.'caseId']]></ee:set-variable>
			</ee:variables>
        </ee:transform>
        <http:request method="GET" doc:name="Get case" doc:id="2b6870d1-be85-418e-912c-e0843720c84d" config-ref="case-management-sys-http-request-configuration" path="cases/{caseId}">
			<reconnect />
			<http:headers ><![CDATA[#[%dw 2.0
output application/json
---
{
	client_id : "34kjkf",
	client_secret: "asd343wd",
	correlation_id: vars.headers.correlationId
}]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"caseId" : vars.caseId
}]]]></http:uri-params>
		</http:request>
		<choice doc:name="Choice" doc:id="480122e5-8dc6-4ecc-995f-ff7e63106da2" >
			<when expression="#[payload.statusCode == 200]">
				<flow-ref doc:name="get-person" doc:id="c8b9cf5c-7bee-41cf-976b-b1e9e8ded7f6" name="get-person" />
				<flow-ref doc:name="get-diagnosis" doc:id="6d062c50-fe9f-4661-b67e-522856fe8e3d" name="get-diagnosis" />
				<flow-ref doc:name="get-procedure" doc:id="6b11d77e-cc4e-4ae2-ae1f-bd2ecffbef9e" name="get-procedure" />
				<flow-ref doc:name="get-contacttrace" doc:id="d31ae360-7502-451e-b21b-72b0ba3889de" name="get-contacttrace" />
				<ee:transform doc:name="build response" doc:id="9319edfb-93aa-42df-a4d8-96e83c16a6bc">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json

var person = vars.persons.person
var procedure = vars.procedures.procedure
var diagnois = vars.diagnoses.diagnosis
var contactTrace = vars.contactTraces.contactTrace
---

payload ++ 
{
"person"  : person,
"procedure" : procedure, 
"diagnoses" : diagnois,
"contactTrace" : contactTrace
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			</when>
			<otherwise >
				<avio-core:custom-logger doc:name="Log Default" doc:id="e87c3c35-70fc-47fc-b812-26f45307a5ec" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" level="ERROR" tracePoint="EXCEPTION" category="${logcat}" message="The Case doesn't exist"/>
				<raise-error doc:name="Raise error" doc:id="7a3490cf-58e1-4304-87aa-017d0c098bc3" type="ANY"/>
			</otherwise>
		</choice>
		<avio-core:custom-logger doc:name="Log End" doc:id="494303a6-7111-42fa-b442-61465b9d9f5b" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" message="Completed Processing Request for get-case" category="${logcat}" />
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="ae9258c7-7711-4bb2-b310-87e6e4f9c854" >
				<avio-core:custom-logger doc:name="Log Error" doc:id="b0d7b16a-fb07-4fe0-a0f0-011e5555b113" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" level="ERROR" tracePoint="EXCEPTION" category="${logcat}" message="Error while get-case flow"/>
				<set-variable value="get-case" doc:name="Set current-flow" doc:id="e1b0ce8f-3f0c-4e7d-ad06-20fd616faa2f" variableName="currentFlow"/>
			</on-error-propagate>
		</error-handler>
	</flow>
	<sub-flow name="get-contacttrace" doc:id="f9dae9a8-3a05-49bd-864e-7686490b0cfd" >
	<avio-core:custom-logger doc:name="Log Start" doc:id="27a595f9-cb42-48ad-8cd0-0b3c70068b97" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" tracePoint="START" category="${logcat}" message="Start Processing Request for get-contacttrace"/>
		
		<try doc:name="Try" doc:id="54088b01-e4aa-4a6d-8990-fe4f7d354fdf" >
			<http:request method="GET" doc:name="Get contactTrace" doc:id="a9cf7800-5af5-45a4-905d-d17d5e2758a4" config-ref="infectious-disease-sys-http-request-configuration" path="cases/{caseId}/contactTrace" target="contactTraces">
			<reconnect />
			<http:headers><![CDATA[#[%dw 2.0
output application/json
---
{
	client_id : vars.headers.client_id,
	client_secret: vars.headers.client_secret,
	correlation_id: vars.headers.correlationId
}]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"caseId" : vars.caseId
}]]]></http:uri-params>
		</http:request>
			<error-handler >
				<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="5c47da09-4d9b-420f-aebe-94bd365c293e" >
					<avio-core:custom-logger doc:name="Log Error" doc:id="c4d8799d-7c63-495a-84ee-81e15313f134" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" message="Error while get-person subflow" payload='#[write(error,"application/json")]' level="ERROR" tracePoint="EXCEPTION" category="${logcat}" />
					<set-variable value="get-contactTrace" doc:name="Set current-flow" doc:id="685c8a0d-0a25-415f-bef9-a59a1995a328" variableName="currentFlow"/>
				</on-error-propagate>
			</error-handler>
		</try>
		<avio-core:custom-logger doc:name="Log End" doc:id="6029769e-744f-4ab2-beee-76547f504a0c" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" tracePoint="END" category="${logcat}" message="Completed Processing Request for get-contacttrace"/>
	</sub-flow>
	<sub-flow name="get-diagnosis" doc:id="0bb587e0-f6a5-441a-a0f9-0e7378b64e6b" >
		<avio-core:custom-logger doc:name="Log Start" doc:id="0ebb96f5-1e65-42a5-9b27-86691a88740f" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" tracePoint="START" category="${logcat}" message="Start Processing Request for get-diagnosis"/>
		<try doc:name="Try" doc:id="523ff52e-8b86-4cbf-9e2d-09cea6d6ee37" >
			<http:request method="GET" doc:name="Get diagnoses" doc:id="c7b54ce3-72c5-4280-8b4c-c4a65172a386" config-ref="case-management-sys-http-request-configuration" path="/cases/{caseId}/diagnoses" target="diagnoses">
			<reconnect />
			<http:headers><![CDATA[#[%dw 2.0
output application/json
---
{
	client_id : "34kjkf",
	client_secret: "asd343wd",
	correlation_id: vars.headers.correlationId
}]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"caseId" : vars.caseId
}]]]></http:uri-params>
		</http:request>
			<error-handler >
				<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="80437376-a655-429a-99d9-e3e12c3ae661" >
					<avio-core:custom-logger doc:name="Log Error" doc:id="74046a8a-012e-4a71-b074-9d73261cd260" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" message="Error while get-person subflow" payload='#[write(error,"application/json")]' level="ERROR" tracePoint="EXCEPTION" category="${logcat}" />
					<set-variable value="get-diagnosis" doc:name="Set current-flow" doc:id="6d42907b-d4f9-4856-aa0e-168b23a3da0d" variableName="currentFlow"/>
				</on-error-propagate>
			</error-handler>
		</try>
		<avio-core:custom-logger doc:name="Log End" doc:id="c13a636f-d6bc-451d-90cb-89277707e8a5" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" message="Completed Processing Request for get-diagnosis" tracePoint="END" category="${logcat}" />
	</sub-flow>
	<sub-flow name="get-procedure" doc:id="b23ac4da-1aa4-436f-9957-30f24c807b5b" >
		<avio-core:custom-logger doc:name="Log Start" doc:id="656093c0-61e2-4c2f-b277-6335f5f8caf1" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" message="Start Processing Request for get-procedure" tracePoint="START" category="${logcat}" />
		<try doc:name="Try" doc:id="5d549375-9614-4cff-b85a-15b313b9e2b1" >
			<http:request method="GET" doc:name="Get procedure" doc:id="5bbdea5b-1f9f-47e9-85ca-3301c58d2797" config-ref="case-management-sys-http-request-configuration" path="/cases/{caseId}/procedures" target="procedures">
			<reconnect />
			<http:headers><![CDATA[#[%dw 2.0
output application/json
---
{
	client_id : "34kjkf",
	client_secret: "asd343wd",
	correlation_id: vars.headers.correlationId
}]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"caseId" : vars.caseId
}]]]></http:uri-params>
		</http:request>
			<error-handler >
				<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="21f2c93b-7142-4f25-8a92-694c6da37ddc" >
					<avio-core:custom-logger doc:name="Log Error" doc:id="c432ee6a-61c9-437b-bb3e-35c41a05c251" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" message="Error while get-person subflow" level="ERROR" tracePoint="EXCEPTION" category="${logcat}" payload='#[write(error,"application/json")]'/>
					<set-variable value="get-procedure" doc:name="Set current-flow" doc:id="75bd7778-a566-43a4-9f11-261f827d690d" variableName="currentFlow"/>
				</on-error-propagate>
			</error-handler>
		</try>
		<avio-core:custom-logger doc:name="Log End" doc:id="712de64b-8253-417c-98b7-8a101d7cd776" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" message="Completed Processing Request for get-procedure" tracePoint="END" category="${logcat}" />
	</sub-flow>
	<sub-flow name="get-person" doc:id="2fd94ce8-9111-4600-9867-72fbe17abb55" >
		<avio-core:custom-logger doc:name="Log Start" doc:id="e876d192-13b3-4bd0-a57a-fcaec0e64e5b" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" message="Start Processing Request for get-person" tracePoint="START" category="${logcat}" />
		<try doc:name="Try" doc:id="ece4c327-54cd-43d0-8b0d-2bb65decf68d" >
			<http:request method="GET" doc:name="Get person" doc:id="f9abcafb-0f25-4d7e-b086-97fffef6d78b" config-ref="case-management-sys-http-request-configuration" path="/cases/{caseId}/persons" target="persons">
			<reconnect />
			<http:headers><![CDATA[#[%dw 2.0
output application/json
---
{
	client_id : "34kjkf",
	client_secret: "asd343wd",
	correlation_id: vars.headers.correlationId
}]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"caseId" : vars.caseId
}]]]></http:uri-params>
		</http:request>
			<error-handler >
				<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="26412357-3f66-4eba-a7b8-1c3a7b364321" >
					<avio-core:custom-logger doc:name="Log Error" doc:id="2ee1157d-cc07-49b5-a90d-5ad5eaaa2dbd" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" level="ERROR" tracePoint="EXCEPTION" category="${logcat}" message="Error while get-case flow" payload='#[write(error,"application/json")]'/>
					<set-variable value="get-case" doc:name="Set current-flow" doc:id="13dd154a-6721-437e-9597-f609b9aec72e" variableName="currentFlow"/>
				</on-error-propagate>
				
			</error-handler>
		</try>
		<avio-core:custom-logger doc:name="Log End" doc:id="d569a9d1-fb2b-4417-887f-76c78dff0863" config-ref="avio-core-config" correlation_id="#[vars.headers.correlationId]" message="Completed Processing Request for get-diagnosis" tracePoint="END" category="${logcat}" />
	</sub-flow>

	</mule>
